# E01 广告投入与销量关系分析：从数据到可视化（静态+交互）

## 一、实验目标

- 理解"变量关系可视化"在业务分析中的作用：辅助判断投放与销量是否相关、是否存在异常点
- 掌握用 Pandas 构造/读取数据并进行基本检查（字段、缺失、范围）
- 掌握两类可视化：静态图（Seaborn）与交互图（Plotly），并能解释各自适用场景
- 初步形成"Notebook（讲解）+ src（复用）+ scripts（复现）"的工程化习惯

## 二、前置要求

- 已创建并激活本项目虚拟环境 `.venv`
- VS Code 已安装 Python 与 Jupyter 插件
- Notebook Kernel 选择 `Python (course-lab)`

## 三、实验内容与步骤

### Step 1：准备数据

**目标**：构造并检查实验数据

在 Notebook 中构造 DataFrame，包含以下字段：
- `month`：月份（1月-6月）
- `sales`：销量（单位：万元）
- `ad_spend`：广告投入（单位：万元）

**检查操作**：
```python
# 查看前几行
df.head()

# 查看数据统计特征
print(df[['sales', 'ad_spend']].describe())
```

**检查点**：
- 确认数据类型正确（数值字段为 int/float）
- 确认无缺失值（NaN）
- 确认数据范围合理（无明显异常值）

---

### Step 2：静态可视化（Seaborn）

**目标**：绘制散点图并进行相关性分析

**相关性分析**：
计算皮尔逊相关系数，衡量广告投入与销量之间的线性关系强度
- 相关系数范围：-1 到 1
- 接近 1：强正相关（广告投入越多，销量越高）
- 接近 0：无线性关系
- 接近 -1：强负相关（广告投入越多，销量越低）

```python
correlation = df['sales'].corr(df['ad_spend'])
print(f"皮尔逊相关系数: {correlation:.4f}")
```

**绘制散点图**：
```python
import matplotlib.pyplot as plt
import seaborn as sns

plt.figure(figsize=(10, 6))
sns.regplot(
    data=df,
    x='ad_spend',
    y='sales',
    scatter_kws={'s': 100, 'alpha': 0.7},      # 散点样式
    line_kws={'color': 'red', 'linewidth': 2}  # 趋势线样式
)
plt.title('销量 vs 广告投入', fontsize=14, fontweight='bold')
plt.xlabel('广告投入 (万元)', fontsize=12)
plt.ylabel('销量 (万元)', fontsize=12)
plt.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```

**图表解读**：
- 观察散点的分布趋势：是否呈现线性关系
- 检查离群点：是否存在明显偏离趋势线的数据点
- 讨论业务含义：是否所有月份广告投入都有效转化为销量提升

**深度思考问题**：
- 是否存在离群点？如何解释？
- 是否可能有滞后效应（本月投入影响下月销量）？
- 是否有其他因素影响销量（如季节性、促销活动）？

---

### Step 3：交互式可视化（Plotly）

**目标**：体验交互式图表的优势

**绘制交互式散点图**：
```python
import plotly.express as px

fig = px.scatter(
    df,
    x='ad_spend',
    y='sales',
    title='销量 vs 广告投入',
    labels={'ad_spend': '广告投入 (万元)', 'sales': '销量 (万元)'},
    trendline='ols'  # 添加线性回归趋势线
)
fig.show()
```

**交互式功能**：
- **Hover**：将鼠标悬停在数据点上，查看具体数值
- **Zoom**：框选或滚动鼠标进行局部放大
- **Pan**：拖拽移动图表视角
- **Legend**：点击右侧图例控制数据显示/隐藏

**对比静态图**：

| 特性 | Seaborn（静态） | Plotly（交互） |
|------|-----------------|-----------------|
| **渲染方式** | 生成 PNG/SVG 静态图片 | 生成 HTML+JavaScript 交互页面 |
| **用户体验** | 固定视角，信息密度受限 | 可自由探索，发现更多细节 |
| **应用场景** | 论文、演讲幻灯片、报告文档 | 在线仪表板、Web 应用、实时分析 |
| **文件大小** | 小（几十 KB） | 较大（几百 KB） |
| **学习难度** | 简单 | 中等 |
| **中文支持** | 需要配置系统字体 | 自动支持（浏览器原生） |

**选择建议**：
- **课堂讲解**：使用交互图（便于即时探索、回答提问）
- **业务汇报**：根据汇报环境选择（线下幻灯片用静态图，在线会议用交互图）
- **文档报告**：使用静态图（便于打印、存档）

---

### Step 4：工程化复用

**目标**：将可视化逻辑封装，实现"一次编写、多处调用"

**第一步：在 `src/viz.py` 中封装函数**

```python
# src/viz.py
import plotly.express as px

def plot_sales_vs_ads_interactive(df):
    """
    绘制销量与广告投入的交互式散点图
    
    参数：
        df (pd.DataFrame): 包含 'ad_spend' 和 'sales' 列的 DataFrame
    
    返回：
        fig (plotly.graph_objs._figure.Figure): Plotly 图表对象
    """
    fig = px.scatter(
        df,
        x='ad_spend',
        y='sales',
        title='销量 vs 广告投入（交互式）',
        labels={'ad_spend': '广告投入 (万元)', 'sales': '销量 (万元)'},
        trendline='ols'
    )
    return fig
```

**第二步：在 Notebook 中调用**

```python
from src.viz import plot_sales_vs_ads_interactive

fig = plot_sales_vs_ads_interactive(df)
fig.show()
```

**第三步：创建复现脚本 `scripts/run_e01_demo.py`**

```python
# scripts/run_e01_demo.py
import sys
sys.path.insert(0, '/path/to/course-lab')

import pandas as pd
from src.viz import plot_sales_vs_ads_interactive

# 构造数据
df = pd.DataFrame({
    "month": ["Jan","Feb","Mar","Apr","May","Jun"],
    "sales": [120, 135, 128, 160, 172, 190],
    "ad_spend": [20, 22, 21, 26, 27, 30]
})

# 生成图表
fig = plot_sales_vs_ads_interactive(df)
fig.write_html("output/e01_scatter_plot.html")
print("✓ 图表已保存到 output/e01_scatter_plot.html")
```

**工程化优势**：
- **代码复用**：同一个函数可在多个 Notebook 和脚本中使用
- **易于维护**：修改逻辑只需改动 `src/viz.py`，所有调用处自动更新
- **可追溯性**：清晰的函数文档和版本控制记录
- **团队协作**：函数接口明确，便于多人开发

---

## 四、验收要求（建议评分点）

| 项目 | 占比 | 验收标准 |
|------|------|---------|
| **图表生成** | 40% | ✓ 能在 Notebook 中成功生成 Seaborn 静态图<br>✓ 能生成 Plotly 交互图<br>✓ 图表标题、坐标轴标签清晰 |
| **图表解读** | 30% | ✓ 能用 3-5 句话解释图表含义<br>✓ 能识别相关性强度<br>✓ 能提出业务问题（离群点、滞后效应等） |
| **工程化实现** | 20% | ✓ 能将绘图逻辑封装到 `src/viz.py`<br>✓ Notebook 能成功 import 并调用<br>✓ 函数包含文档字符串 |
| **代码质量** | 10% | ✓ 变量命名合理（避免 a, b, x1, x2 等）<br>✓ 代码注释清晰<br>✓ 文件结构符合项目规范 |

---

## 五、常见问题与排查

### Q1: `ModuleNotFoundError: No module named 'src'`

**原因**：Python 路径中没有包含项目根目录

**解决方案**：
```bash
# 在项目根目录执行
pip install -e .
```

然后在 Notebook 中重启 Kernel（Ctrl+Shift+P → Restart Kernel）

---

### Q2: `ModuleNotFoundError: No module named 'plotly'`

**原因**：plotly 未安装或安装到了不同的虚拟环境

**解决方案**：
```bash
# 在 Notebook 中执行（会自动使用正确的虚拟环境）
%pip install plotly

# 然后重启 Kernel
```

---

### Q3: Matplotlib 中文显示为方块 / 出现字体警告

**原因**：matplotlib 默认使用 DejaVu Sans 字体，不支持中文字形

**解决方案**：在 Notebook 开头添加字体配置代码
```python
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import warnings
warnings.filterwarnings('ignore')

# 获取系统可用字体
all_fonts = [f.name for f in fm.fontManager.ttflist]
available_fonts = set(all_fonts)

# macOS 常见中文字体
chinese_fonts = ['PingFang SC', 'STHeiti', 'STSongti', 'Songti SC', 'Heiti SC']

# 配置使用第一个可用字体
for font in chinese_fonts:
    if font in available_fonts:
        plt.rcParams['font.sans-serif'] = [font]
        break

plt.rcParams['axes.unicode_minus'] = False
```

---

### Q4: VS Code 解释器与 Kernel 不一致

**现象**：在 Notebook 中 import 失败，但在终端中可以运行

**原因**：VS Code Python 解释器和 Kernel 指向不同的虚拟环境

**解决方案**：
1. 点击 Notebook 右上角的 Kernel 选择器
2. 选择 `Python (course-lab)`
3. 或点击 VS Code 左下角的 Python 版本，切换到 `.venv`

---

## 六、作业（任选其二）

### 作业 1：时间序列拓展与多因素分析

**要求**：
1. 将数据扩展为 12 个月的完整年度数据
2. 添加一个"促销活动"变量（二值：0 无促销，1 有促销）
3. 用不同颜色的散点表示有无促销
4. 讨论：促销对销量的影响如何体现在图中？

**参考代码框架**：
```python
df_extended = pd.DataFrame({
    "month": list(range(1, 13)),
    "sales": [120, 135, 128, 160, 172, 190, 185, 210, 200, 225, 240, 250],
    "ad_spend": [20, 22, 21, 26, 27, 30, 28, 35, 32, 38, 40, 42],
    "promotion": [0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1]
})

# 用 color 参数区分促销情况
fig = px.scatter(
    df_extended,
    x='ad_spend',
    y='sales',
    color='promotion',
    ...
)
```

---

### 作业 2：回归线的业务含义

**要求**：
1. 在 Seaborn 中添加回归趋势线（已默认包含在 `regplot`）
2. 计算回归线的斜率（广告投入增加 1 万元，销量增加多少）
3. 用 3-5 句话说明：
   - 趋势线能回答什么问题？（e.g., 平均投资回报率）
   - 趋势线不能回答什么问题？（e.g., 是否存在因果关系、滞后效应）

**参考代码**：
```python
import numpy as np
from scipy import stats

# 计算回归系数
slope, intercept, r_value, p_value, std_err = stats.linregress(df['ad_spend'], df['sales'])
print(f"回归斜率: {slope:.2f} （广告投入增加 1 万元，销量增加 {slope:.2f} 万元）")
print(f"R-squared: {r_value**2:.4f} （模型解释度）")
```

---

### 作业 3：管理层友好的图表表达

**要求**：
1. 重新设计图表的标题、坐标轴标签、注释
2. 从"管理层关心的决策视角"重新表述
3. 添加关键数据点标注（如最高投入月、最高销量月）

**示例**：
```python
# 原始表述（技术向）
plt.title('销量 vs 广告投入')

# 管理层表述（决策向）
plt.title('广告投入与销量关系分析\n数据表明：广告投入每增加100万元，预期销量增加约XX万元', 
          fontsize=14, fontweight='bold')
```

---

## 七、参考资源

### 相关库文档
- [Pandas 官方文档](https://pandas.pydata.org/docs/)
- [Seaborn 官方文档](https://seaborn.pydata.org/)
- [Plotly 官方文档](https://plotly.com/python/)

### 统计学基础
- [皮尔逊相关系数](https://en.wikipedia.org/wiki/Pearson_correlation_coefficient)
- [线性回归](https://en.wikipedia.org/wiki/Linear_regression)

### 数据可视化最佳实践
- Tufte, E. R. (2001). *The Visual Display of Quantitative Information*
- Cairo, A. (2012). *The Functional Art: An Introduction to Information Graphics and Visualization*

---

**更新日期**：2026 年 1 月 30 日  
**版本**：1.0
